<?xml version="1.0" encoding="utf-8"?>
<tool id="dcp-matrix-service-retrieve" name="HCA DCP Matrix Service Data Retrieval" version="v0.0.1+galaxy0">
  <description>Retrieves expression matrices and metadata.</description>
  <requirements>
    <requirement type="package" version="0.0.2">hca-matrix-downloader</requirement>
  </requirements>
  <command detect_errors="exit_code"><![CDATA[

hca-matrix-downloader -p '${project}' -f mtx -o out
&&
hca-mtx-to-10x out.mtx .
&&
gunzip -c out.mtx/cells.tsv.gz > exp_design.tsv

]]></command>

  <inputs>
    <param name="project" type="text" value="Single cell transcriptome analysis of human pancreas" label="Human Cell Atlas project name/feature/UUID" help="HCA project identifier, can be project title, project label or project UUID."/>
  </inputs>

  <outputs>
    <data name="matrix_mtx" format="txt" from_work_dir="matrix.mtx" label="${tool.name} on ${on_string} matrix.mtx"/>
    <data name="genes_tsv" format="tsv" from_work_dir="genes.tsv" label="${tool.name} on ${on_string} genes.tsv"/>
    <data name="barcode_tsv" format="tsv" from_work_dir="barcodes.tsv" label="${tool.name} on ${on_string} barcodes.tsv"/>
    <data name="cells_meta_tsv" format="tsv" from_work_dir="exp_design.tsv" label="${tool.name} on ${on_string} exp_design.tsv"/>
  </outputs>

  <tests>
    <test>
      <param name="project" value="Single cell transcriptome analysis of human pancreas"/>
      <output name="matrix_mtx" file="matrix.mtx" ftype="txt"/>
      <output name="genes_tsv" file="genes.tsv" ftype="tsv"/>
      <output name="barcode_tsv" file="barcodes.tsv" ftype="tsv"/>
      <output name="cells_meta_tsv" file="exp_design.tsv" ftype="tsv"/>
    </test>
  </tests>

  <help><![CDATA[
Down expression matrix from HCA projects using HCA DCP's matrix service API
---------------------------------------------------------------------------

The data retrieval tool presented here allows the user to retrieve expression matrices
and metadata for any public experiment available at Human Cell Atlas data portal.

To use it, simply set the name, or label, or ID for the desired project, which can be
found at the HCA data browser (https://prod.data.humancellatlas.org/explore/projects).

Outputs will be:

:Matrix (txt):
  Contains the expression values for genes (rows) and cells (columns) in raw counts.
  This text file is formatted as a Matrix Market file, and as such it is accompanied by
  separate files for the gene identifiers and the cells identifiers.

:Genes (tsv):
  Identifiers (column repeated) for the genes present in the matrix of expression,
  in the same order as the matrix rows.

:Barcodes (tsv):
  Identifiers for the cells of the data matrix. The file is ordered to match the columns
  of the matrix.

:Experiment Design file (tsv):
  Contains metadata for the different cells of the experiment.

]]></help>
  <citations>
    <citation type="doi">10.7554/eLife.27041</citation>
  </citations>
</tool>
